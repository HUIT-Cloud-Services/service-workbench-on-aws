{"version":3,"sources":["../../../src/models/workflow-templates/WorkflowTemplateStep.js"],"names":["_","types","getEnv","getParent","applySnapshot","getSnapshot","StepTemplateVersion","titles","title","desc","skippable","supportedPropsOverrideKeys","PropsOverrideOption","model","allowed","optional","array","string","actions","self","setAllowed","replace","views","overrideSummaryRows","canOverride","prop","includes","result","name","forEach","index","push","ConfigOverrideOption","cloneDeep","configSummaryRows","map","keyBy","key","entry","undefined","WorkflowTemplateStep","id","stepTemplateId","stepTemplateVer","maybeNull","number","maybe","propsOverrideOption","configOverrideOption","stepTemplate","boolean","defaults","union","null","integer","afterCreate","isEmpty","console","warn","setDesc","setTitle","setDefaults","setSkippable","setConfigOverrideOption","option","setPropsOverrideOption","templateId","templateVer","derivedTitle","derivedDesc","descHtml","showdown","convert","assets","propertyOverrideSummaryRows","isNil","propertySummaryRows","value","inputManifest","additional","flattened","k","v","configOverrideSummaryRows"],"mappings":"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","sourcesContent":["/*\n *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\").\n *  You may not use this file except in compliance with the License.\n *  A copy of the License is located at\n *\n *  http://aws.amazon.com/apache2.0\n *\n *  or in the \"license\" file accompanying this file. This file is distributed\n *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n *  express or implied. See the License for the specific language governing\n *  permissions and limitations under the License.\n */\n\nimport _ from 'lodash';\nimport { types, getEnv, getParent, applySnapshot, getSnapshot } from 'mobx-state-tree';\n\nimport { StepTemplateVersion } from '../workflow-step-templates/StepTemplate';\n\nconst titles = {\n  title: 'Title',\n  desc: 'Description',\n  skippable: 'Skip this step if pervious steps failed',\n};\n\nconst supportedPropsOverrideKeys = ['title', 'desc', 'skippable'];\n\n// ==================================================================\n// PropsOverrideOption\n// ==================================================================\nconst PropsOverrideOption = types\n  .model('PropsOverrideOption', {\n    allowed: types.optional(types.array(types.string), []),\n  })\n  .actions(self => ({\n    setAllowed(allowed = []) {\n      self.allowed.replace(allowed);\n    },\n  }))\n  .views(self => ({\n    get overrideSummaryRows() {\n      const canOverride = prop => self.allowed.includes(prop);\n\n      const result = [\n        { title: titles.title, allowed: canOverride('title'), name: 'title' },\n        { title: titles.desc, allowed: canOverride('desc'), name: 'desc' },\n        { title: titles.skippable, allowed: canOverride('skippable'), name: 'skippable' },\n      ];\n\n      _.forEach(self.allowed, (prop, index) => {\n        if (supportedPropsOverrideKeys.includes(prop)) return;\n        result.push({ title: prop, allowed: true, name: `${index}-${prop}` });\n      });\n\n      return result;\n    },\n  }));\n\n// ==================================================================\n// ConfigOverrideOption\n// ==================================================================\nconst ConfigOverrideOption = types\n  .model('ConfigOverrideOption', {\n    allowed: types.optional(types.array(types.string), []),\n  })\n  .actions(self => ({\n    setAllowed(allowed = []) {\n      self.allowed.replace(allowed);\n    },\n  }))\n  .views(self => ({\n    get overrideSummaryRows() {\n      const result = _.cloneDeep(getParent(self).configSummaryRows || []);\n      const map = _.keyBy(result, 'name');\n      self.allowed.forEach(key => {\n        const entry = map[key];\n        if (entry !== undefined) {\n          entry.allowed = true;\n        } else {\n          result.push({ name: key, allowed: true });\n        }\n      });\n\n      return result;\n    },\n  }));\n\n// ==================================================================\n// WorkflowTemplateStep\n// ==================================================================\nconst WorkflowTemplateStep = types\n  .model('WorkflowTemplateStep', {\n    id: '',\n    stepTemplateId: '',\n    stepTemplateVer: types.maybeNull(types.number),\n    title: types.maybe(types.string),\n    desc: types.maybe(types.string),\n    propsOverrideOption: types.optional(PropsOverrideOption, {}),\n    configOverrideOption: types.optional(ConfigOverrideOption, {}),\n    stepTemplate: StepTemplateVersion,\n    skippable: types.maybe(types.boolean),\n    defaults: types.optional(\n      types.map(types.union(types.null, types.undefined, types.integer, types.number, types.boolean, types.string)),\n      {},\n    ),\n  })\n  .actions(self => ({\n    afterCreate() {\n      if (_.isEmpty(self.id))\n        console.warn(`There is no id provided for this workflow template step`, getSnapshot(self));\n    },\n\n    setDesc(desc) {\n      if (desc === self.stepTemplate.desc) self.desc = undefined;\n      else self.desc = desc;\n    },\n\n    setTitle(title) {\n      if (title === self.stepTemplate.title) self.title = undefined;\n      else self.title = title;\n    },\n\n    setDefaults(defaults = {}) {\n      self.defaults.replace(defaults);\n    },\n\n    setSkippable(skippable) {\n      self.skippable = skippable;\n    },\n\n    setConfigOverrideOption(option) {\n      applySnapshot(self.configOverrideOption, option);\n    },\n\n    setPropsOverrideOption(option) {\n      applySnapshot(self.propsOverrideOption, option);\n    },\n  }))\n\n  .views(self => ({\n    get templateId() {\n      return self.stepTemplateId;\n    },\n\n    get templateVer() {\n      return self.stepTemplateVer;\n    },\n\n    get derivedTitle() {\n      return self.title || self.stepTemplate.title;\n    },\n\n    get derivedDesc() {\n      return self.desc || self.stepTemplate.desc;\n    },\n\n    get descHtml() {\n      const showdown = getEnv(self).showdown;\n      return showdown.convert(self.derivedDesc, self.assets); // TODO declare assets\n    },\n\n    get propertyOverrideSummaryRows() {\n      if (_.isNil(self.propsOverrideOption)) return [];\n      return self.propsOverrideOption.overrideSummaryRows;\n    },\n\n    get propertySummaryRows() {\n      return [\n        {\n          title: titles.skippable,\n          value: self.skippable,\n        },\n      ];\n    },\n\n    get configSummaryRows() {\n      // First, we build a map of all the input manifest entries\n      // Then, for entries where we actually have a config value in the 'defaults', we\n      // populate the value attribute in the entry.\n      const inputManifest = self.stepTemplate.inputManifest;\n\n      // We use 'additional' to keep track of entries that was not part of the inputManifest but yet there is a key in 'configs' for it.\n      // The order of the rows might be useful, so we try to preserve it by keeping track of additional\n      const additional = [];\n      let flattened = [];\n      let map = {};\n\n      if (inputManifest) {\n        flattened = _.cloneDeep(inputManifest.flattened || []);\n        map = _.keyBy(flattened, 'name');\n      }\n\n      /* eslint-disable no-restricted-syntax, no-unused-vars */\n      for (const [k, v] of self.defaults) {\n        let entry = map[k];\n        if (entry === undefined) {\n          entry = { name: k };\n          additional.push(entry);\n        }\n        entry.value = v;\n        map[k] = entry;\n      }\n      /* eslint-enable no-restricted-syntax, no-unused-vars */\n\n      return [...flattened, ...additional];\n    },\n\n    get configOverrideSummaryRows() {\n      if (_.isNil(self.configOverrideOption)) return [];\n      return self.configOverrideOption.overrideSummaryRows;\n    },\n  }));\n\nexport { WorkflowTemplateStep, PropsOverrideOption, ConfigOverrideOption, supportedPropsOverrideKeys };\n"],"file":"WorkflowTemplateStep.js"}