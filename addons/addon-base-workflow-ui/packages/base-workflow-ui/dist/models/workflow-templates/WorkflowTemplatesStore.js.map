{"version":3,"sources":["../../../src/models/workflow-templates/WorkflowTemplatesStore.js"],"names":["_","types","BaseStore","uiEventBus","getWorkflowTemplates","WorkflowTemplate","WorkflowTemplatesStore","named","props","templates","optional","map","tickPeriod","actions","self","superCleanup","cleanup","doLoad","versions","toTemplates","runInAction","previousKeys","forEach","_value","key","template","id","hasPrevious","has","addTemplate","delete","rawTemplate","previous","get","put","setWorkflowTemplate","clear","views","empty","size","total","list","result","push","reverse","sortBy","getTemplate","version","entry","values","registerContextItems","appContext","workflowTemplatesStore","create","listenTo","listener","_event"],"mappings":"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","sourcesContent":["/*\n *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\").\n *  You may not use this file except in compliance with the License.\n *  A copy of the License is located at\n *\n *  http://aws.amazon.com/apache2.0\n *\n *  or in the \"license\" file accompanying this file. This file is distributed\n *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n *  express or implied. See the License for the specific language governing\n *  permissions and limitations under the License.\n */\n\nimport _ from 'lodash';\nimport { types } from 'mobx-state-tree';\nimport { BaseStore } from '@aws-ee/base-ui/dist/models/BaseStore';\nimport { uiEventBus } from '@aws-ee/base-ui/dist/models/SessionStore';\n\nimport { getWorkflowTemplates } from '../../helpers/api';\nimport { WorkflowTemplate } from './WorkflowTemplate';\n\n// ==================================================================\n// WorkflowTemplatesStore\n// ==================================================================\nconst WorkflowTemplatesStore = BaseStore.named('WorkflowTemplatesStore')\n  .props({\n    templates: types.optional(types.map(WorkflowTemplate), {}),\n    tickPeriod: 900 * 1000, // 15 minutes\n  })\n\n  .actions(self => {\n    // save the base implementation of cleanup\n    const superCleanup = self.cleanup;\n\n    return {\n      async doLoad() {\n        const versions = await getWorkflowTemplates();\n        const templates = toTemplates(versions);\n\n        // we try to preserve existing template versions data and merge the new data instead\n        self.runInAction(() => {\n          const previousKeys = {};\n          self.templates.forEach((_value, key) => {\n            previousKeys[key] = true;\n          });\n          templates.forEach(template => {\n            const id = template.id;\n            const hasPrevious = self.templates.has(id);\n\n            self.addTemplate(template);\n\n            if (hasPrevious) {\n              delete previousKeys[id];\n            }\n          });\n\n          _.forEach(previousKeys, (_value, key) => {\n            self.templates.delete(key);\n          });\n        });\n      },\n\n      addTemplate(rawTemplate) {\n        const id = rawTemplate.id;\n        const previous = self.templates.get(id);\n\n        if (!previous) {\n          self.templates.put(rawTemplate);\n        } else {\n          previous.setWorkflowTemplate(rawTemplate);\n        }\n      },\n\n      cleanup: () => {\n        self.templates.clear();\n        superCleanup();\n      },\n    };\n  })\n\n  .views(self => ({\n    get empty() {\n      return self.templates.size === 0;\n    },\n\n    get total() {\n      return self.templates.size;\n    },\n\n    get list() {\n      const result = [];\n      self.templates.forEach(template => result.push(template));\n\n      return _.reverse(_.sortBy(result, ['latest.createdAt', 'title']));\n      // return result;\n    },\n\n    getTemplate(id) {\n      return self.templates.get(id);\n    },\n  }));\n\n// Given an array of [ { id: tmp1, v: 0, ... }, { id: tmp1, v:1, ... } ]\n// return an array of the grouping of the template versions based on their ids\n// [ { id, versions: [ ... ] }, { id, versions: [ ... ] }, ...]\nfunction toTemplates(versions) {\n  const map = {};\n  _.forEach(versions, version => {\n    const id = version.id;\n    const entry = map[id] || { id, versions: [] };\n    entry.versions.push(version);\n    map[id] = entry;\n  });\n\n  return _.values(map);\n}\n\nfunction registerContextItems(appContext) {\n  appContext.workflowTemplatesStore = WorkflowTemplatesStore.create({}, appContext);\n\n  uiEventBus.listenTo('workflowTemplatePublished', {\n    id: 'WorkflowTemplatesStore',\n    listener: async _event => {\n      appContext.workflowTemplatesStore.cleanup();\n    },\n  });\n}\n\nexport { WorkflowTemplatesStore, registerContextItems };\n"],"file":"WorkflowTemplatesStore.js"}