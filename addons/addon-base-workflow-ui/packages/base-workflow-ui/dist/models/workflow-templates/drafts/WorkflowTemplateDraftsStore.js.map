{"version":3,"sources":["../../../../src/models/workflow-templates/drafts/WorkflowTemplateDraftsStore.js"],"names":["_","types","getSnapshot","getEnv","BaseStore","getWorkflowTemplateDrafts","createWorkflowTemplateDraft","updateWorkflowTemplateDraft","publishWorkflowTemplateDraft","deleteWorkflowTemplateDraft","WorkflowTemplateDraft","WorkflowTemplateDraftsStore","named","props","drafts","optional","map","tickPeriod","actions","self","superCleanup","cleanup","normalizeForSubmission","draft","normalizedDraft","cloneDeep","forEach","template","selectedSteps","step","stepTemplate","doLoad","runInAction","previousKeys","value","key","id","hasPrevious","has","addDraft","delete","rawDraft","previous","get","put","setWorkflowTemplateDraft","updateDraft","undefined","Error","updated","createDraft","isNewTemplate","templateId","templateTitle","publishDraft","publishResult","hasErrors","deleteDraft","uiEventBus","fireEvent","clear","views","empty","size","total","list","result","push","reverse","sortBy","hasTemplate","found","values","hasDraft","draftId","getDraft","registerContextItems","appContext","workflowTemplateDraftsStore","create"],"mappings":"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","sourcesContent":["/*\n *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\").\n *  You may not use this file except in compliance with the License.\n *  A copy of the License is located at\n *\n *  http://aws.amazon.com/apache2.0\n *\n *  or in the \"license\" file accompanying this file. This file is distributed\n *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n *  express or implied. See the License for the specific language governing\n *  permissions and limitations under the License.\n */\n\nimport _ from 'lodash';\nimport { types, getSnapshot, getEnv } from 'mobx-state-tree';\nimport { BaseStore } from '@aws-ee/base-ui/dist/models/BaseStore';\n\nimport {\n  getWorkflowTemplateDrafts,\n  createWorkflowTemplateDraft,\n  updateWorkflowTemplateDraft,\n  publishWorkflowTemplateDraft,\n  deleteWorkflowTemplateDraft,\n} from '../../../helpers/api';\nimport WorkflowTemplateDraft from './WorkflowTemplateDraft';\n\n// ==================================================================\n// WorkflowTemplateDraftsStore\n// ==================================================================\nconst WorkflowTemplateDraftsStore = BaseStore.named('WorkflowTemplateDraftsStore')\n  .props({\n    drafts: types.optional(types.map(WorkflowTemplateDraft), {}),\n    tickPeriod: 900 * 1000, // 15 minutes\n  })\n\n  .actions(self => {\n    // save the base implementation of cleanup\n    const superCleanup = self.cleanup;\n\n    // private\n    function normalizeForSubmission(draft) {\n      const normalizedDraft = _.cloneDeep(getSnapshot(draft));\n      _.forEach(normalizedDraft.template.selectedSteps, step => {\n        delete step.stepTemplate;\n      });\n\n      return normalizedDraft;\n    }\n\n    return {\n      async doLoad() {\n        const drafts = await getWorkflowTemplateDrafts();\n\n        // We try to preserve existing drafts data and merge the new data instead\n        // We could have used self.drafts.replace(), but it will do clear().merge()\n        self.runInAction(() => {\n          const previousKeys = {};\n          self.drafts.forEach((value, key) => {\n            previousKeys[key] = true;\n          });\n          drafts.forEach(draft => {\n            const id = draft.id;\n            const hasPrevious = self.drafts.has(id);\n\n            self.addDraft(draft);\n\n            if (hasPrevious) {\n              delete previousKeys[id];\n            }\n          });\n\n          _.forEach(previousKeys, (value, key) => {\n            self.drafts.delete(key);\n          });\n        });\n      },\n\n      addDraft(rawDraft) {\n        const id = rawDraft.id;\n        const previous = self.drafts.get(id);\n\n        if (!previous) {\n          self.drafts.put(rawDraft);\n        } else {\n          previous.setWorkflowTemplateDraft(rawDraft);\n        }\n      },\n\n      async updateDraft(draft) {\n        const id = draft.id;\n        const previous = self.drafts.get(id);\n        if (previous === undefined) throw new Error(`Workflow Template Draft \"${id}\" does not exist`);\n\n        const updated = await updateWorkflowTemplateDraft(normalizeForSubmission(draft));\n        previous.setWorkflowTemplateDraft(updated);\n\n        return previous;\n      },\n\n      async createDraft({ isNewTemplate, templateId, templateTitle }) {\n        const draft = await createWorkflowTemplateDraft({ isNewTemplate, templateId, templateTitle });\n        self.addDraft(draft);\n\n        return draft;\n      },\n\n      async publishDraft(draft) {\n        const id = draft.id;\n        const previous = self.drafts.get(id);\n        if (previous === undefined) throw new Error(`Workflow Template Draft \"${id}\" does not exist`);\n\n        const publishResult = await publishWorkflowTemplateDraft(normalizeForSubmission(draft));\n\n        self.runInAction(() => {\n          if (!publishResult.hasErrors) self.drafts.delete(id);\n        });\n\n        return publishResult;\n      },\n\n      async deleteDraft(draft) {\n        const uiEventBus = getEnv(self).uiEventBus;\n        await deleteWorkflowTemplateDraft(draft);\n        await uiEventBus.fireEvent('workflowTemplateDraftDeleted', draft);\n        self.runInAction(() => {\n          self.drafts.delete(draft.id);\n        });\n      },\n\n      cleanup: () => {\n        self.drafts.clear();\n        superCleanup();\n      },\n    };\n  })\n\n  .views(self => ({\n    get empty() {\n      return self.drafts.size === 0;\n    },\n\n    get total() {\n      return self.drafts.size;\n    },\n\n    get list() {\n      const result = [];\n      self.drafts.forEach(drafts => result.push(drafts));\n\n      return _.reverse(_.sortBy(result, ['createdAt', 'title']));\n    },\n\n    hasTemplate(templateId) {\n      let found = false;\n      /* eslint-disable no-restricted-syntax, no-unused-vars */\n      for (const draft of self.drafts.values()) {\n        if (draft.template.id === templateId) {\n          found = true;\n          break;\n        }\n      }\n      /* eslint-enable no-restricted-syntax, no-unused-vars */\n\n      return found;\n    },\n\n    hasDraft(draftId) {\n      return self.drafts.has(draftId);\n    },\n\n    getDraft(id) {\n      return self.drafts.get(id);\n    },\n  }));\n\nfunction registerContextItems(appContext) {\n  appContext.workflowTemplateDraftsStore = WorkflowTemplateDraftsStore.create({}, appContext);\n}\n\nexport { WorkflowTemplateDraftsStore, registerContextItems };\n"],"file":"WorkflowTemplateDraftsStore.js"}