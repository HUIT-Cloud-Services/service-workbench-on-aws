{"version":3,"sources":["../../../src/models/workflow-step-templates/StepTemplatesStore.js"],"names":["_","types","BaseStore","getStepTemplates","StepTemplate","StepTemplatesStore","named","props","templates","optional","map","tickPeriod","actions","self","superCleanup","cleanup","doLoad","versions","toTemplates","runInAction","previousKeys","forEach","value","key","template","id","hasPrevious","has","addTemplate","delete","rawTemplate","previous","get","put","setStepTemplate","clear","views","empty","size","total","list","result","push","sortBy","getTemplate","version","entry","values","registerContextItems","appContext","stepTemplatesStore","create"],"mappings":"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","sourcesContent":["/*\n *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\").\n *  You may not use this file except in compliance with the License.\n *  A copy of the License is located at\n *\n *  http://aws.amazon.com/apache2.0\n *\n *  or in the \"license\" file accompanying this file. This file is distributed\n *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n *  express or implied. See the License for the specific language governing\n *  permissions and limitations under the License.\n */\n\nimport _ from 'lodash';\nimport { types } from 'mobx-state-tree';\nimport { BaseStore } from '@aws-ee/base-ui/dist/models/BaseStore';\n\nimport { getStepTemplates } from '../../helpers/api';\nimport { StepTemplate } from './StepTemplate';\n\n// ==================================================================\n// StepTemplatesStore\n// ==================================================================\nconst StepTemplatesStore = BaseStore.named('StepTemplatesStore')\n  .props({\n    templates: types.optional(types.map(StepTemplate), {}),\n    tickPeriod: 900 * 1000, // 15 minutes\n  })\n\n  .actions(self => {\n    // save the base implementation of cleanup\n    const superCleanup = self.cleanup;\n\n    return {\n      async doLoad() {\n        const versions = await getStepTemplates();\n        const templates = toTemplates(versions);\n\n        // we try to preserve existing template versions data and merge the new data instead\n        self.runInAction(() => {\n          const previousKeys = {};\n          self.templates.forEach((value, key) => {\n            previousKeys[key] = true;\n          });\n          templates.forEach(template => {\n            const id = template.id;\n            const hasPrevious = self.templates.has(id);\n\n            self.addTemplate(template);\n\n            if (hasPrevious) {\n              delete previousKeys[id];\n            }\n          });\n\n          _.forEach(previousKeys, (value, key) => {\n            self.templates.delete(key);\n          });\n        });\n      },\n\n      addTemplate(rawTemplate) {\n        const id = rawTemplate.id;\n        const previous = self.templates.get(id);\n\n        if (!previous) {\n          self.templates.put(rawTemplate);\n        } else {\n          previous.setStepTemplate(rawTemplate);\n        }\n      },\n\n      cleanup: () => {\n        self.templates.clear();\n        superCleanup();\n      },\n    };\n  })\n\n  .views(self => ({\n    get empty() {\n      return self.templates.size === 0;\n    },\n\n    get total() {\n      return self.templates.size;\n    },\n\n    get list() {\n      const result = [];\n      self.templates.forEach(template => result.push(template));\n\n      return _.sortBy(result, ['latest.title']);\n    },\n\n    getTemplate(id) {\n      return self.templates.get(id);\n    },\n  }));\n\n// Given an array of [ { id: tmp1, v: 0, ... }, { id: tmp1, v:1, ... } ]\n// return an array of the grouping of the template versions based on their ids\n// [ { id, versions: [ ... ] }, { id, versions: [ ... ] }, ...]\nfunction toTemplates(versions) {\n  const map = {};\n  _.forEach(versions, version => {\n    const id = version.id;\n    const entry = map[id] || { id, versions: [] };\n    entry.versions.push(version);\n    map[id] = entry;\n  });\n\n  return _.values(map);\n}\n\nfunction registerContextItems(appContext) {\n  appContext.stepTemplatesStore = StepTemplatesStore.create({}, appContext);\n}\n\nexport { StepTemplatesStore, registerContextItems };\n"],"file":"StepTemplatesStore.js"}