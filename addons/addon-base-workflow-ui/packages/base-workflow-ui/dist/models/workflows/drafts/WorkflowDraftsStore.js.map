{"version":3,"sources":["../../../../src/models/workflows/drafts/WorkflowDraftsStore.js"],"names":["_","types","getSnapshot","getEnv","BaseStore","getWorkflowDrafts","createWorkflowDraft","updateWorkflowDraft","publishWorkflowDraft","deleteWorkflowDraft","WorkflowDraft","WorkflowDraftsStore","named","props","drafts","optional","map","tickPeriod","actions","self","superCleanup","cleanup","normalizeForSubmission","draft","normalizedDraft","cloneDeep","forEach","workflow","selectedSteps","step","stepTemplate","configOverrideOption","propsOverrideOption","stepsOrderChanged","instancesMap","doLoad","runInAction","previousKeys","_value","key","id","hasPrevious","has","addDraft","delete","rawDraft","previous","get","put","setWorkflowDraft","updateDraft","undefined","Error","updated","createDraft","isNewWorkflow","workflowId","templateId","publishDraft","publishResult","hasErrors","deleteDraft","uiEventBus","fireEvent","clear","views","empty","size","total","list","result","push","reverse","sortBy","hasWorkflow","found","values","hasDraft","draftId","getDraft","registerContextItems","appContext","workflowDraftsStore","create"],"mappings":"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","sourcesContent":["/*\n *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\").\n *  You may not use this file except in compliance with the License.\n *  A copy of the License is located at\n *\n *  http://aws.amazon.com/apache2.0\n *\n *  or in the \"license\" file accompanying this file. This file is distributed\n *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n *  express or implied. See the License for the specific language governing\n *  permissions and limitations under the License.\n */\n\nimport _ from 'lodash';\nimport { types, getSnapshot, getEnv } from 'mobx-state-tree';\nimport { BaseStore } from '@aws-ee/base-ui/dist/models/BaseStore';\n\nimport {\n  getWorkflowDrafts,\n  createWorkflowDraft,\n  updateWorkflowDraft,\n  publishWorkflowDraft,\n  deleteWorkflowDraft,\n} from '../../../helpers/api';\nimport WorkflowDraft from './WorkflowDraft';\n\n// ==================================================================\n// WorkflowDraftsStore\n// ==================================================================\nconst WorkflowDraftsStore = BaseStore.named('WorkflowDraftsStore')\n  .props({\n    drafts: types.optional(types.map(WorkflowDraft), {}),\n    tickPeriod: 900 * 1000, // 15 minutes\n  })\n\n  .actions(self => {\n    // save the base implementation of cleanup\n    const superCleanup = self.cleanup;\n\n    // private\n    function normalizeForSubmission(draft) {\n      const normalizedDraft = _.cloneDeep(getSnapshot(draft));\n      _.forEach(normalizedDraft.workflow.selectedSteps, step => {\n        delete step.stepTemplate;\n        delete step.configOverrideOption;\n        delete step.propsOverrideOption;\n      });\n\n      delete normalizedDraft.workflow.stepsOrderChanged;\n      delete normalizedDraft.workflow.instancesMap;\n      return normalizedDraft;\n    }\n\n    return {\n      async doLoad() {\n        const drafts = await getWorkflowDrafts();\n\n        // We try to preserve existing drafts data and merge the new data instead\n        // We could have used self.drafts.replace(), but it will do clear() then merge()\n        self.runInAction(() => {\n          const previousKeys = {};\n          self.drafts.forEach((_value, key) => {\n            previousKeys[key] = true;\n          });\n          drafts.forEach(draft => {\n            const id = draft.id;\n            const hasPrevious = self.drafts.has(id);\n\n            self.addDraft(draft);\n\n            if (hasPrevious) {\n              delete previousKeys[id];\n            }\n          });\n\n          _.forEach(previousKeys, (_value, key) => {\n            self.drafts.delete(key);\n          });\n        });\n      },\n\n      addDraft(rawDraft) {\n        const id = rawDraft.id;\n        const previous = self.drafts.get(id);\n\n        if (!previous) {\n          self.drafts.put(rawDraft);\n        } else {\n          previous.setWorkflowDraft(rawDraft);\n        }\n      },\n\n      async updateDraft(draft) {\n        const id = draft.id;\n        const previous = self.drafts.get(id);\n        if (previous === undefined) throw new Error(`Workflow Draft \"${id}\" does not exist`);\n\n        const updated = await updateWorkflowDraft(normalizeForSubmission(draft));\n        previous.setWorkflowDraft(updated);\n\n        return previous;\n      },\n\n      async createDraft({ isNewWorkflow, workflowId, templateId }) {\n        const draft = await createWorkflowDraft({ isNewWorkflow, workflowId, templateId });\n        self.addDraft(draft);\n\n        return draft;\n      },\n\n      async publishDraft(draft) {\n        const id = draft.id;\n        const previous = self.drafts.get(id);\n        if (previous === undefined) throw new Error(`Workflow Draft \"${id}\" does not exist`);\n\n        const publishResult = await publishWorkflowDraft(normalizeForSubmission(draft));\n        self.runInAction(() => {\n          if (!publishResult.hasErrors) self.drafts.delete(id);\n        });\n\n        return publishResult;\n      },\n\n      async deleteDraft(draft) {\n        const uiEventBus = getEnv(self).uiEventBus;\n        await deleteWorkflowDraft(draft);\n        await uiEventBus.fireEvent('workflowDraftDeleted', draft);\n        self.runInAction(() => {\n          self.drafts.delete(draft.id);\n        });\n      },\n\n      cleanup: () => {\n        self.drafts.clear();\n        superCleanup();\n      },\n    };\n  })\n\n  .views(self => ({\n    get empty() {\n      return self.drafts.size === 0;\n    },\n\n    get total() {\n      return self.drafts.size;\n    },\n\n    get list() {\n      const result = [];\n      self.drafts.forEach(drafts => result.push(drafts));\n\n      return _.reverse(_.sortBy(result, ['createdAt', 'title']));\n    },\n\n    hasWorkflow(workflowId) {\n      let found = false;\n      /* eslint-disable no-restricted-syntax, no-unused-vars */\n      for (const draft of self.drafts.values()) {\n        if (draft.workflow.id === workflowId) {\n          found = true;\n          break;\n        }\n      }\n      /* eslint-enable no-restricted-syntax, no-unused-vars */\n\n      return found;\n    },\n\n    hasDraft(draftId) {\n      return self.drafts.has(draftId);\n    },\n\n    getDraft(id) {\n      return self.drafts.get(id);\n    },\n  }));\n\nfunction registerContextItems(appContext) {\n  appContext.workflowDraftsStore = WorkflowDraftsStore.create({}, appContext);\n}\n\nexport { WorkflowDraftsStore, registerContextItems };\n"],"file":"WorkflowDraftsStore.js"}