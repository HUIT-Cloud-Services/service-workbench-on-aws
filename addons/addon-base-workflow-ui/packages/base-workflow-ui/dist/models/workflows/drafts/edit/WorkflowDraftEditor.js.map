{"version":3,"sources":["../../../../../src/models/workflows/drafts/edit/WorkflowDraftEditor.js"],"names":["types","getEnv","clone","uiEventBus","getEditWorkflowDraftMetaForm","WorkflowStepEditor","globals","WorkflowDraftEditor","model","draftId","currentPage","numPages","stepEditors","optional","map","volatile","_self","draftCopy","undefined","draftMetaForm","actions","self","makeDraftCopy","runInAction","draft","originalDraft","workflow","fn","afterCreate","nextPage","previousPage","cancel","getStepEditor","step","stepId","id","entry","get","create","set","removeStepEditor","delete","addStep","version","update","updatedDraft","workflowDraftsStore","updateDraft","setRev","rev","publish","result","publishDraft","hasErrors","fireEvent","views","hasNextPage","hasPreviousPage","store","getDraft","metaForm","stepEditorsEditing","found","editor","values","editing","getWorkflowDraftEditor","sessionStore","encodeId","removeEditor","removeStartsWith","registerContextItems","appContext","listenTo","listener","event"],"mappings":"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","sourcesContent":["/*\n *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\").\n *  You may not use this file except in compliance with the License.\n *  A copy of the License is located at\n *\n *  http://aws.amazon.com/apache2.0\n *\n *  or in the \"license\" file accompanying this file. This file is distributed\n *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n *  express or implied. See the License for the specific language governing\n *  permissions and limitations under the License.\n */\n\nimport { types, getEnv, clone } from 'mobx-state-tree';\nimport { uiEventBus } from '@aws-ee/base-ui/dist/models/SessionStore';\n\nimport getEditWorkflowDraftMetaForm from '../../../forms/EditWorkflowDraftMetaForm';\nimport WorkflowStepEditor from './WorkflowStepEditor';\n\nlet globals; // a reference to the globals\n\n// ==================================================================\n// WorkflowDraftEditor\n// ==================================================================\nconst WorkflowDraftEditor = types\n  .model('WorkflowDraftEditor', {\n    draftId: '',\n    currentPage: 0, // there are only two pages, one for meta editing and one for steps editing\n    numPages: 3,\n    stepEditors: types.optional(types.map(WorkflowStepEditor), {}),\n  })\n\n  .volatile(_self => ({\n    draftCopy: undefined,\n    draftMetaForm: undefined,\n  }))\n\n  .actions(self => {\n    // private\n    function makeDraftCopy() {\n      self.runInAction(() => {\n        const draft = self.originalDraft;\n        self.draftCopy = clone(draft);\n        self.draftMetaForm = getEditWorkflowDraftMetaForm(self.draftCopy.workflow);\n      });\n    }\n\n    return {\n      // I had issues using runInAction from mobx\n      // the issue is discussed here https://github.com/mobxjs/mobx-state-tree/issues/915\n      runInAction(fn) {\n        return fn();\n      },\n\n      afterCreate() {\n        makeDraftCopy();\n      },\n\n      nextPage() {\n        if (self.currentPage < self.numPages - 1) self.currentPage += 1;\n        else self.currentPage = self.numPages - 1;\n        return self.currentPage;\n      },\n\n      previousPage() {\n        if (self.currentPage > 0) self.currentPage -= 1;\n        else self.currentPage = 0;\n        return self.currentPage;\n      },\n\n      cancel() {\n        // We make a fresh copy in case the existing copy one was used\n        makeDraftCopy();\n        self.currentPage = 0;\n      },\n\n      getStepEditor(step) {\n        const stepId = step.id;\n        const entry = self.stepEditors.get(stepId) || WorkflowStepEditor.create({ stepId }, getEnv(self));\n\n        self.stepEditors.set(stepId, entry);\n        return entry;\n      },\n\n      removeStepEditor(stepId) {\n        self.stepEditors.delete(stepId);\n      },\n\n      addStep(step) {\n        const version = self.version;\n        version.addStep(step);\n      },\n\n      async update(draft) {\n        const updatedDraft = await self.workflowDraftsStore.updateDraft(draft);\n        // The following code is not the greatest idea, but okay for this scenario, the correct approach would have\n        // been to call makeDraftCopy(), however, this will result in losing some of the ui states in the draft card\n        self.draft.setRev(updatedDraft.rev);\n      },\n\n      async publish(draft) {\n        const result = await self.workflowDraftsStore.publishDraft(draft);\n\n        // Remove the editor from the session store, if there were no errors\n        if (!result.hasErrors) {\n          await uiEventBus.fireEvent('workflowDraftDeleted', draft);\n        }\n\n        return result;\n      },\n    };\n  })\n\n  .views(self => ({\n    get workflowDraftsStore() {\n      return getEnv(self).workflowDraftsStore;\n    },\n\n    get hasNextPage() {\n      return self.currentPage < self.numPages - 1;\n    },\n\n    get hasPreviousPage() {\n      return self.currentPage > 0;\n    },\n\n    get originalDraft() {\n      const store = self.workflowDraftsStore;\n      return store.getDraft(self.draftId);\n    },\n\n    get draft() {\n      return self.draftCopy;\n    },\n\n    // Returns a WorkflowVersion model object\n    get version() {\n      return self.draft.workflow;\n    },\n\n    get metaForm() {\n      return self.draftMetaForm;\n    },\n\n    // Returns true if at least one step editor is in edit mode\n    get stepEditorsEditing() {\n      let found = false;\n      /* eslint-disable no-restricted-syntax, no-unused-vars */\n      for (const editor of self.stepEditors.values()) {\n        if (editor.editing) {\n          found = true;\n          break;\n        }\n      }\n      /* eslint-enable no-restricted-syntax, no-unused-vars */\n      return found;\n    },\n  }));\n\nfunction getWorkflowDraftEditor(draftId) {\n  const sessionStore = globals.sessionStore;\n  const id = encodeId(draftId);\n  const entry = sessionStore.map.get(id) || WorkflowDraftEditor.create({ draftId }, globals);\n\n  sessionStore.map.set(id, entry);\n  return entry;\n}\n\nfunction encodeId(draftId) {\n  return `WorkflowDraftEditor-${draftId}`;\n}\n\nfunction removeEditor(draftId) {\n  const sessionStore = globals.sessionStore;\n  const id = encodeId(draftId);\n\n  sessionStore.removeStartsWith(id);\n}\n\nfunction registerContextItems(appContext) {\n  // we are not actually registering anything here, just getting a reference to the appContext\n  globals = appContext;\n\n  uiEventBus.listenTo('workflowDraftDeleted', {\n    id: 'WorkflowDraftEditor',\n    listener: async event => {\n      // event will be the draft object\n      removeEditor(event.id);\n    },\n  });\n}\n\nexport { WorkflowDraftEditor, getWorkflowDraftEditor, registerContextItems };\n"],"file":"WorkflowDraftEditor.js"}