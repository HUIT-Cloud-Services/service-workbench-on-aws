{"version":3,"sources":["../../../../../src/models/workflows/drafts/edit/WorkflowStepEditor.js"],"names":["_","types","getParent","getEnv","getSnapshot","visit","getWorkflowStepDescForm","getWorkflowStepPropsForm","ConfigurationEditor","WorkflowStepEditor","model","stepId","contentExpanded","configEdit","descEdit","propsEdit","volatile","_self","configurationEditor","undefined","stepDescForm","stepPropsForm","actions","self","runInAction","fn","afterAttach","step","inputManifest","get","configs","allowed","configOverrideOption","defaults","create","isUndefined","prepareInputManifest","configuration","isTemplate","setContentExpanded","flag","setConfigEdit","setDescEdit","setPropsEdit","applyConfigs","setConfigs","applyDescAndTitle","desc","title","setDesc","setTitle","applySkippable","skippable","setSkippable","views","version","getStep","parentEditor","workflowVersion","workflowTemplateVersion","template","workflowTemplateStep","descForm","propsForm","editing","rawDefaults","isEmpty","names","copy","cloneDeep","visitFn","item","name","includes","disabled","set","has","default","forEach","sections","section","children"],"mappings":"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","sourcesContent":["/*\n *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\").\n *  You may not use this file except in compliance with the License.\n *  A copy of the License is located at\n *\n *  http://aws.amazon.com/apache2.0\n *\n *  or in the \"license\" file accompanying this file. This file is distributed\n *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n *  express or implied. See the License for the specific language governing\n *  permissions and limitations under the License.\n */\n\nimport _ from 'lodash';\nimport { types, getParent, getEnv, getSnapshot } from 'mobx-state-tree';\nimport { visit } from '@aws-ee/base-ui/dist/models/forms/InputManifest';\n\nimport getWorkflowStepDescForm from '../../../forms/WorkflowStepDescForm';\nimport getWorkflowStepPropsForm from '../../../forms/WorkflowStepPropsForm';\nimport ConfigurationEditor from '../../../configuration/ConfigurationEditor';\n\n// ==================================================================\n// WorkflowStepEditor\n// ==================================================================\nconst WorkflowStepEditor = types\n  .model('WorkflowStepEditor', {\n    stepId: '', // The step id for the workflow step\n    contentExpanded: false,\n    configEdit: false, // If we are editing mode or not for the configuration section\n    descEdit: false, // If we are editing mode or not for the description section\n    propsEdit: false, // If we are editing mode or not for the props section\n  })\n\n  .volatile(_self => ({\n    configurationEditor: undefined,\n    stepDescForm: undefined,\n    stepPropsForm: undefined,\n  }))\n\n  .actions(self => {\n    return {\n      // I had issues using runInAction from mobx\n      // the issue is discussed here https://github.com/mobxjs/mobx-state-tree/issues/915\n      runInAction(fn) {\n        return fn();\n      },\n\n      afterAttach() {\n        if (self.configurationEditor !== undefined) return;\n        const step = self.step;\n        const inputManifest = _.get(step, 'stepTemplate.inputManifest');\n        const configs = getSnapshot(step.configs);\n        const allowed = step.configOverrideOption.allowed;\n        const defaults = self.defaults;\n\n        self.configurationEditor = ConfigurationEditor.create(\n          {\n            inputManifest: _.isUndefined(inputManifest)\n              ? undefined\n              : prepareInputManifest(inputManifest, { allowed, defaults }),\n            configuration: configs,\n          },\n          getEnv(self),\n        );\n\n        self.stepDescForm = getWorkflowStepDescForm(step, { isTemplate: false });\n        self.stepPropsForm = getWorkflowStepPropsForm(step, { isTemplate: false });\n      },\n\n      setContentExpanded(flag) {\n        self.contentExpanded = !!flag; // !! will simply turn any type to a boolean type\n      },\n\n      setConfigEdit(flag) {\n        self.configEdit = flag;\n      },\n\n      setDescEdit(flag) {\n        self.descEdit = flag;\n      },\n\n      setPropsEdit(flag) {\n        self.propsEdit = flag;\n      },\n\n      applyConfigs(configs = {}) {\n        self.step.setConfigs(configs);\n      },\n\n      applyDescAndTitle(desc, title) {\n        self.step.setDesc(desc);\n        self.step.setTitle(title);\n        self.stepDescForm = getWorkflowStepDescForm(self.step, { isTemplate: false });\n      },\n\n      applySkippable(skippable) {\n        self.step.setSkippable(skippable);\n        self.stepPropsForm = getWorkflowStepPropsForm(self.step, { isTemplate: false });\n      },\n    };\n  })\n\n  .views(self => ({\n    get step() {\n      const version = self.version;\n      return version.getStep(self.stepId);\n    },\n\n    // WorkflowVersion\n    get version() {\n      const parentEditor = getParent(self, 2);\n      return parentEditor.version;\n    },\n\n    // The workflow template step defaults (if this workflow step has an associated workflow template step with it)\n    get defaults() {\n      const workflowVersion = self.version;\n      if (!workflowVersion) return undefined;\n      const workflowTemplateVersion = workflowVersion.template;\n      if (!workflowTemplateVersion) return undefined;\n      const workflowTemplateStep = workflowTemplateVersion.getStep(self.stepId);\n      if (!workflowTemplateStep) return undefined;\n\n      return workflowTemplateStep.defaults;\n    },\n\n    get descForm() {\n      return self.stepDescForm;\n    },\n\n    get propsForm() {\n      return self.stepPropsForm;\n    },\n\n    get editing() {\n      return self.configEdit || self.descEdit || self.propsEdit;\n    },\n  }));\n\n// Returns a copy of the input manifest (but as a json object), the copy has its entries updated as follows:\n// - If the entry name is not allowed to be overridden, then disabled is turned on with a warn message in the extra section\n// - If there is a default value for the given key, then it is set on the entry\nfunction prepareInputManifest(inputManifest, { allowed = [], defaults: rawDefaults }) {\n  if (_.isEmpty(inputManifest)) return inputManifest;\n  const names = inputManifest.names;\n  const copy = _.cloneDeep(getSnapshot(inputManifest));\n  const defaults = rawDefaults ? getSnapshot(rawDefaults) : {};\n\n  const visitFn = item => {\n    if (!item.name) return undefined;\n    const name = item.name;\n    if (!names.includes(name)) return undefined;\n\n    if (!allowed.includes(name)) {\n      item.disabled = true;\n      _.set(item, 'extra.warn', 'The workflow template used by this workflow does not allow you to modify this field');\n    }\n\n    if (_.has(defaults, name)) {\n      item.default = defaults[name];\n    }\n    return item;\n  };\n\n  _.forEach(copy.sections, section => {\n    visit(section.children, visitFn);\n  });\n\n  return copy;\n}\n\nexport default WorkflowStepEditor;\n"],"file":"WorkflowStepEditor.js"}