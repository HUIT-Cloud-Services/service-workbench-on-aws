{"version":3,"sources":["../../../src/models/workflows/WorkflowStep.js"],"names":["_","types","getEnv","getSnapshot","PropsOverrideOption","ConfigOverrideOption","supportedPropsOverrideKeys","titles","title","desc","skippable","WorkflowStep","model","id","stepTemplateId","stepTemplateVer","maybeNull","number","maybe","string","propsOverrideOption","optional","configOverrideOption","boolean","configs","map","union","null","undefined","integer","actions","self","afterCreate","isEmpty","console","warn","setDesc","setTitle","setConfigs","replace","setSkippable","makeNew","setAllowed","slice","stepTemplate","inputManifest","names","views","templateId","templateVer","descHtml","showdown","convert","assets","v","stepTemplatesStore","getTemplate","getVersion","propertySummaryRows","value","configSummaryRows","additional","flattened","cloneDeep","keyBy","k","entry","name","push"],"mappings":"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","sourcesContent":["/*\n *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\").\n *  You may not use this file except in compliance with the License.\n *  A copy of the License is located at\n *\n *  http://aws.amazon.com/apache2.0\n *\n *  or in the \"license\" file accompanying this file. This file is distributed\n *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n *  express or implied. See the License for the specific language governing\n *  permissions and limitations under the License.\n */\n\nimport _ from 'lodash';\nimport { types, getEnv, getSnapshot } from 'mobx-state-tree';\n\nimport {\n  PropsOverrideOption,\n  ConfigOverrideOption,\n  supportedPropsOverrideKeys,\n} from '../workflow-templates/WorkflowTemplateStep';\n\nconst titles = {\n  title: 'Title',\n  desc: 'Description',\n  skippable: 'Skip this step if pervious steps failed',\n};\n\n// ==================================================================\n// WorkflowStep\n// ==================================================================\nconst WorkflowStep = types\n  .model('WorkflowStep', {\n    id: '',\n    stepTemplateId: '',\n    stepTemplateVer: types.maybeNull(types.number),\n    title: types.maybe(types.string),\n    desc: types.maybe(types.string),\n    propsOverrideOption: types.optional(PropsOverrideOption, {}),\n    configOverrideOption: types.optional(ConfigOverrideOption, {}),\n    skippable: types.maybe(types.boolean),\n    configs: types.optional(\n      types.map(types.union(types.null, types.undefined, types.integer, types.number, types.boolean, types.string)),\n      {},\n    ),\n  })\n  .actions(self => ({\n    afterCreate() {\n      if (_.isEmpty(self.id)) console.warn(`There is no id provided for this workflow step`, getSnapshot(self));\n    },\n\n    setDesc(desc) {\n      self.desc = desc;\n    },\n\n    setTitle(title) {\n      self.title = title;\n    },\n\n    setConfigs(configs = {}) {\n      self.configs.replace(configs);\n    },\n\n    setSkippable(skippable) {\n      self.skippable = skippable;\n    },\n\n    // You should only use this method if the workflow step is added manually by the user (when allowed)\n    // do not make a WorkflowStep that came from the server as new.\n    makeNew() {\n      self.propsOverrideOption.setAllowed(_.slice(supportedPropsOverrideKeys));\n      const stepTemplate = self.stepTemplate;\n      if (!stepTemplate) return;\n      const inputManifest = stepTemplate.inputManifest;\n      if (!inputManifest) return;\n      const names = inputManifest.names;\n      self.configOverrideOption.setAllowed(names);\n    },\n  }))\n\n  .views(self => ({\n    get templateId() {\n      return self.stepTemplateId;\n    },\n\n    get templateVer() {\n      return self.stepTemplateVer;\n    },\n\n    get descHtml() {\n      const showdown = getEnv(self).showdown;\n      return showdown.convert(self.desc, self.assets); // TODO declare assets\n    },\n\n    get stepTemplate() {\n      const id = self.stepTemplateId;\n      const v = self.stepTemplateVer;\n      const stepTemplatesStore = getEnv(self).stepTemplatesStore;\n      if (!stepTemplatesStore) return undefined;\n\n      const stepTemplate = stepTemplatesStore.getTemplate(id);\n      if (!stepTemplate) return undefined;\n      return stepTemplate.getVersion(v);\n    },\n\n    get propertySummaryRows() {\n      return [\n        {\n          title: titles.skippable,\n          value: self.skippable,\n        },\n      ];\n    },\n\n    get configSummaryRows() {\n      // First, we build a map of all the input manifest entries\n      // Then, for entries where we actually have a config value in the 'configs', we\n      // populate the value attribute in the entry.\n      const stepTemplate = self.stepTemplate;\n      if (stepTemplate === undefined) return [];\n      const inputManifest = stepTemplate.inputManifest;\n\n      // We use 'additional' to keep track of entries that was not part of the inputManifest but yet there is a key in 'configs' for it.\n      // The order of the rows might be useful, so we try to preserve it by keeping track of additional\n      const additional = [];\n      let flattened = [];\n      let map = {};\n\n      if (inputManifest) {\n        flattened = _.cloneDeep(inputManifest.flattened || []);\n        map = _.keyBy(flattened, 'name');\n      }\n\n      /* eslint-disable no-restricted-syntax, no-unused-vars */\n      for (const [k, v] of self.configs) {\n        let entry = map[k];\n        if (entry === undefined) {\n          entry = { name: k };\n          additional.push(entry);\n        }\n        entry.value = v;\n        map[k] = entry;\n      }\n      /* eslint-enable no-restricted-syntax, no-unused-vars */\n\n      return [...flattened, ...additional];\n    },\n  }));\n\nexport default WorkflowStep;\n"],"file":"WorkflowStep.js"}