{"version":3,"sources":["../../../src/parts/data-sources/DataSourceAccountCard.js"],"names":["TabPaneWrapper","props","children","React","Component","DataSourceAccountCard","handleCheckConnection","connectionPanel","show","account","accountsStore","operation","doWork","checkAccountReachability","id","run","handleDismissPanel","expanded","Operation","create","getAccountStore","showPanel","reachable","reachableState","hasMsg","_","isEmpty","statusMessageInfo","message","showMsg","renderTitle","renderStatus","renderStackMismatch","renderTabs","getMenuItemLabel","store","emptySpan","studiesTotal","panes","menuItem","render","secondary","pointing","name","createdAt","createdBy","statusAt","state","color","display","stackOutDated","incorrectStackNameProvisioned","stack","dataSourceAccountsStore","computed","action","observable"],"mappings":"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","sourcesContent":["/*\n *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n *  Licensed under the Apache License, Version 2.0 (the \"License\").\n *  You may not use this file except in compliance with the License.\n *  A copy of the License is located at\n *\n *  http://aws.amazon.com/apache2.0\n *\n *  or in the \"license\" file accompanying this file. This file is distributed\n *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n *  express or implied. See the License for the specific language governing\n *  permissions and limitations under the License.\n */\n\n/* eslint-disable max-classes-per-file */\nimport _ from 'lodash';\nimport React from 'react';\nimport { decorate, computed, observable, action, runInAction } from 'mobx';\nimport { observer, inject, Observer } from 'mobx-react';\nimport { withRouter } from 'react-router-dom';\nimport { Header, Tab, Label, Menu, Button, Message } from 'semantic-ui-react';\nimport TimeAgo from 'react-timeago';\n\nimport { niceNumber, swallowError } from '@aws-ee/base-ui/dist/helpers/utils';\nimport { isStoreError, isStoreNew, isStoreLoading } from '@aws-ee/base-ui/dist/models/BaseStore';\n\nimport By from '../helpers/By';\nimport DataSourceStudiesList from './DataSourceStudiesList';\nimport DataSourceAccountCfn from './DataSourceAccountCfn';\nimport DataSourceAccountInfo from './DataSourceAccountInfo';\nimport { Operation } from '../../models/helpers/Operation';\nimport AccountConnectionPanel from './parts/AccountConnectionPanel';\nimport AccountStatusMessage from './parts/AccountStatusMessage';\n\n// This component is used with the TabPane to replace the default Segment wrapper since\n// we don't want to display the border.\n// eslint-disable-next-line react/prefer-stateless-function\nclass TabPaneWrapper extends React.Component {\n  render() {\n    return <>{this.props.children}</>;\n  }\n}\n\n// expected props\n// - account (via prop)\n// - dataSourceAccountsStore (via injection)\nclass DataSourceAccountCard extends React.Component {\n  constructor(props) {\n    super(props);\n    runInAction(() => {\n      this.expanded = false;\n      this.connectionPanel = {\n        show: false,\n        operation: Operation.create({}),\n      };\n    });\n  }\n\n  get account() {\n    return this.props.account;\n  }\n\n  get accountsStore() {\n    return this.props.dataSourceAccountsStore;\n  }\n\n  getAccountStore() {\n    const accountsStore = this.accountsStore;\n    const account = this.account || {};\n    return accountsStore.getAccountStore(account.id);\n  }\n\n  handleCheckConnection = () => {\n    this.connectionPanel.show = true;\n\n    const account = this.account;\n    const accountsStore = this.accountsStore;\n    const operation = this.connectionPanel.operation;\n    const doWork = async () => {\n      await accountsStore.checkAccountReachability(account.id);\n    };\n\n    swallowError(operation.run(doWork));\n  };\n\n  handleDismissPanel = () => {\n    this.connectionPanel.show = false;\n  };\n\n  render() {\n    const account = this.account;\n    const operation = this.connectionPanel.operation;\n    const showPanel = this.connectionPanel.show;\n    const reachable = account.reachableState;\n    const hasMsg = !_.isEmpty(account.statusMessageInfo.message);\n    const showMsg = !showPanel && (!reachable || (reachable && hasMsg));\n\n    return (\n      <div className=\"animated fadeIn\">\n        <Button size=\"mini\" floated=\"right\" color=\"brown\" basic onClick={this.handleCheckConnection}>\n          Test Connection\n        </Button>\n        {this.renderTitle(account)}\n        {this.renderStatus(account)}\n        {showMsg && <AccountStatusMessage account={account} />}\n        {showPanel && (\n          <AccountConnectionPanel account={account} operation={operation} onCancel={this.handleDismissPanel} />\n        )}\n        {this.renderStackMismatch(account)}\n        {this.renderTabs()}\n      </div>\n    );\n  }\n\n  renderTabs() {\n    const getMenuItemLabel = () => {\n      const store = this.getAccountStore();\n      const emptySpan = null;\n      if (!store) return emptySpan;\n      if (isStoreError(store)) return emptySpan;\n      if (isStoreNew(store)) return emptySpan;\n      if (isStoreLoading(store)) return emptySpan;\n      return <Label>{niceNumber(store.studiesTotal)}</Label>;\n    };\n\n    const account = this.account;\n    const panes = [\n      {\n        menuItem: <Menu.Item key=\"studies\">Studies {getMenuItemLabel()}</Menu.Item>,\n        render: () => (\n          <Tab.Pane attached={false} key=\"studies\" as={TabPaneWrapper}>\n            <Observer>{() => <DataSourceStudiesList account={account} />}</Observer>\n          </Tab.Pane>\n        ),\n      },\n      {\n        menuItem: 'CloudFormation',\n        render: () => (\n          <Tab.Pane attached={false} key=\"cloudformation\" as={TabPaneWrapper}>\n            <Observer>{() => <DataSourceAccountCfn account={account} />}</Observer>\n          </Tab.Pane>\n        ),\n      },\n      {\n        menuItem: 'Account Information',\n        render: () => (\n          <Tab.Pane attached={false} key=\"accountInfo\" as={TabPaneWrapper}>\n            <Observer>{() => <DataSourceAccountInfo account={account} />}</Observer>\n          </Tab.Pane>\n        ),\n      },\n    ];\n\n    return <Tab className=\"mt2\" menu={{ secondary: true, pointing: true }} renderActiveOnly panes={panes} />;\n  }\n\n  renderTitle(account) {\n    return (\n      <Header as=\"h3\" className=\"mt3 breakout\">\n        {account.name}\n        <Header.Subheader>\n          <span className=\"fs-8 color-grey mr1\">\n            Registered <TimeAgo date={account.createdAt} /> <By uid={account.createdBy} className=\"mr1\" />\n            &mdash;\n          </span>\n          <span className=\"fs-8 color-grey mr1\">\n            Status checked <TimeAgo date={account.statusAt} className=\"mr1\" />\n            &mdash;\n          </span>\n          <span className=\"fs-8 color-grey\">AWS Account # {account.id}</span>\n        </Header.Subheader>\n      </Header>\n    );\n  }\n\n  renderStatus(account) {\n    const { state } = account;\n    return (\n      <Label attached=\"top left\" size=\"mini\" color={state.color}>\n        {state.display}\n      </Label>\n    );\n  }\n\n  renderStackMismatch(account) {\n    const stackOutDated = account.stackOutDated;\n    const incorrectStackNameProvisioned = account.incorrectStackNameProvisioned;\n\n    if (!stackOutDated && !incorrectStackNameProvisioned) return null;\n\n    if (incorrectStackNameProvisioned) {\n      return (\n        <Message warning>\n          <Message.Header>Incorrect stack name</Message.Header>\n          <p>\n            It seems that the correct CloudFormation stack was deployed to AWS account <b>{account.id}</b> but with an\n            incorrect stack name. Please ensure that you have the latest CloudFormation template deployed with the stack\n            name {account.stack} in the account. If you just updated the stack you can run the connection test again.\n          </p>\n        </Message>\n      );\n    }\n\n    return (\n      <Message warning>\n        <Message.Header>Stack is outdated</Message.Header>\n        <p>\n          It seems that the CloudFormation stack {account.stack} deployed to AWS account <b>{account.id}</b> is outdated\n          and does not contain the latest changes made. Please use the latest CloudFormation template to update the\n          stack. If you just updated the stack you can run the connection test again.\n        </p>\n      </Message>\n    );\n  }\n}\n\n// see https://medium.com/@mweststrate/mobx-4-better-simpler-faster-smaller-c1fbc08008da\ndecorate(DataSourceAccountCard, {\n  accountsStore: computed,\n  account: computed,\n  handleCheckConnection: action,\n  handleDismissPanel: action,\n  connectionPanel: observable,\n});\n\nexport default inject('dataSourceAccountsStore')(withRouter(observer(DataSourceAccountCard)));\n"],"file":"DataSourceAccountCard.js"}